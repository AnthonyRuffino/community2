{"changed":true,"filter":false,"title":"callLogger.js","tooltip":"/client/app/callLogger.js","value":"////////////////////////////\n//AngularJs Code\n////////////////////////////\nfunction CallLogController($scope, $http) {\n    var socket = io.connect();\n    \n    \n    $scope.insuranceTypes = [];\n    $scope.insuranceTypes.push({ name: '--Select One--', value: null });\n    $scope.insuranceTypes.push({ name: 'Commercial', value: 'Commercial' });\n    $scope.insuranceTypes.push({ name: 'Medicare', value: 'Medicare' });\n    $scope.insuranceTypes.push({ name: 'Medicaid', value: 'Medicaid' });\n    $scope.insuranceTypes.push({ name: 'SelfPay', value: 'SelfPay' });\n    $scope.selectedInsuranceTypeOption = $scope.insuranceTypes[0];\n    \n    $scope.appointmentReasons = [];\n    $scope.appointmentReasons.push({ name: '--Select One--', value: null });\n    $scope.appointmentReasons.push({ name: 'Mental Health - MEDMGMT', value: 'Mental Health - MEDMGMT' });\n    $scope.appointmentReasons.push({ name: 'Mental Health - THERAPY', value: 'Mental Health - THERAPY' });\n    $scope.appointmentReasons.push({ name: 'Substance Abuse - MEDMGMT', value: 'Substance Abuse - MEDMGMT' });\n    $scope.appointmentReasons.push({ name: 'Substance Abuse - THERAPY', value: 'Substance Abuse - THERAPY' });\n    $scope.appointmentReasons.push({ name: 'Evals (Non DUI)', value: 'Evals (Non DUI)' });\n    $scope.appointmentReasons.push({ name: 'DUI', value: 'DUI' });\n    $scope.selectedAppointmentReasonOption = $scope.appointmentReasons[0];\n    \n    $scope.schedulingStatuses = [];\n    $scope.schedulingStatuses.push({ name: '--Select One--', value: null });\n    $scope.schedulingStatuses.push({ name: 'Appointment Set', value: 'Appointment Set' });\n    $scope.schedulingStatuses.push({ name: 'Referred Elsewhere', value: 'Referred Elsewhere' });\n    $scope.schedulingStatuses.push({ name: 'Message Left', value: 'Message Left' });\n    $scope.schedulingStatuses.push({ name: 'Caller Declined to Set Appointment', value: 'Caller Declined to Set Appointment' });\n    $scope.schedulingStatuses.push({ name: 'Psych Express', value: 'Psych Express' });\n    $scope.selectedSchedulingStatusOption = $scope.schedulingStatuses[0];\n    \n    $scope.logs = [];\n    \n    $scope.allLogs = [];\n    \n    socket.on('calllog-log', function (log) {\n        $scope.logs.push(log);\n        $scope.$apply();\n    });\n    \n    socket.on('calllog-clear-all-logs', function () {\n        $scope.allLogs = [];\n    });\n    \n    socket.on('calllog-all-logs', function (log) {\n        $scope.allLogs.push(log);\n        $scope.$apply();\n    });\n    \n    $scope.send = function send() {\n        var log = {};\n        log.insuranceType = $scope.selectedInsuranceTypeOption.value;\n        log.appointmentReason = $scope.selectedAppointmentReasonOption.value;\n        log.schedulingStatus = $scope.selectedSchedulingStatusOption.value;\n        socket.emit('calllog-log', log);\n        $scope.selectedInsuranceTypeOption = $scope.insuranceTypes[0];\n        $scope.selectedAppointmentReasonOption = $scope.appointmentReasons[0];\n        $scope.selectedSchedulingStatusOption = $scope.schedulingStatuses[0];\n    };\n    \n    $scope.getLogs = function getLogs() {\n        socket.emit('calllog-get-all-logs');\n    };\n    \n}\n\n\n////////////////////////////\n//Server Side nodejs code\n////////////////////////////\nvar CallLogServer = {};\nCallLogServer.async = null;\nCallLogServer.guid = null;\nCallLogServer.logs = null;\nCallLogServer.socketHub = null;\nCallLogServer.fs = null;\nCallLogServer.mkpath = null;\nCallLogServer.path = null;\nCallLogServer.dirname = null;\nCallLogServer.moment = null;\n\nCallLogServer.realm = null;\n\n\nCallLogServer.init = function(data){\n    console.log(\"Call Logger server initializing.\");\n    CallLogServer.async = data.async;\n    CallLogServer.guid = data.guid;\n    CallLogServer.realm = data.realm;\n    CallLogServer.logs = [];\n    CallLogServer.socketHub = data.socketHub;\n    CallLogServer.fs = data.fs;\n    CallLogServer.mkpath = data.mkpath;\n    CallLogServer.path = data.path;\n    CallLogServer.dirname = \"/tmp/ssl/calllogs/\";\n    CallLogServer.moment = data.moment;\n};\n\n\nCallLogServer.onConnection = function (socket) {\n    console.log(\"Call Logger server connection.\");\n\n    socket.on('calllog-log', function (log) {\n        if(log !== undefined && log !== null){\n            var field1 = String(log.insuranceType || '');\n            var field2 = String(log.appointmentReason || '');\n            var field3 = String(log.schedulingStatus || '');\n            if (!field1 && !field2 && !field3)\n                return;\n            \n            \n            var moment = CallLogServer.moment();\n            // convert using the TZDB identifier for US Central time\n            moment.tz('America/Chicago');\n            \n            log.dateTime = moment.format(\"YYYY-MM-DD HH:mm:ss\");\n            \n            var id = CallLogServer.guid.generate(true,2);\n            id = moment.format(\"HHmmss\") + \"-\" + id;\n            log.id = id;\n            \n            var strJson = JSON.stringify(log, null, 4); \n            mkfile(CallLogServer.dirname + moment.format(\"YYYY-MM-DD\") + \"/\" + id + \".json\",strJson);\n                \n            broadcast('calllog-log', log);\n            CallLogServer.logs.push(log);\n      }\n    });\n    \n    socket.on('calllog-get-all-logs', function () {\n        \n        \n        \n        socket.emit('calllog-clear-all-logs');\n        \n        walk(process.env.HOME, function(err, results) {\n          if (err) throw err;\n          var logs = [];\n          \n          results.forEach(function (result) {\n              logs.push({file:result});\n          });\n          \n          logs.forEach(function (log) {\n              socket.emit('calllog-all-logs', log);\n          });\n        });\n    });\n};\n    \n\nfunction broadcast(event, data) {\n  CallLogServer.socketHub.broadcast(event, data);\n}\n\n\n// You probably want to pass in a callback to this function to send back errors, normally\nvar mkfile = function (filepath, data) {\n    console.log(\"Saving file: \" + filepath);\n    CallLogServer.mkpath(CallLogServer.path.dirname(filepath), function (err) {\n        if (err) {\n            console.log(err);\n        } else {\n            CallLogServer.fs.writeFile(filepath, data, function(err) {\n                if(err) {\n                    console.log(err);\n                } else {\n                    console.log(\"The file was saved!\");\n                }\n            }); \n        }\n    });\n};\n\n\n\nvar walk = function(dir, done) {\n  var results = [];\n  CallLogServer.fs.readdir(dir, function(err, list) {\n    if (err) return done(err);\n    var i = 0;\n    (function next() {\n      var file = list[i++];\n      if (!file) return done(null, results);\n      file = dir + '/' + file;\n      CallLogServer.fs.stat(file, function(err, stat) {\n        if (stat && stat.isDirectory()) {\n          walk(file, function(err, res) {\n            results = results.concat(res);\n            next();\n          });\n        } else {\n            CallLogServer.fs.readFile(file, 'utf8', function (err,data) {\n              if (err) {\n                return console.log(err);\n              }\n              results.push(file);\n            });\n          next();\n        }\n      });\n    })();\n  });\n};\n\n\n\ntry {\n    exports.init = CallLogServer.init;\n    exports.onConnection = CallLogServer.onConnection;\n}\ncatch(err) {\n    \n}","undoManager":{"mark":-166,"position":100,"stack":[[{"start":{"row":145,"column":0},"end":{"row":145,"column":4},"action":"insert","lines":["    "],"id":1799},{"start":{"row":146,"column":0},"end":{"row":146,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":144,"column":39},"end":{"row":145,"column":14},"action":"remove","lines":["","              "],"id":1800}],[{"start":{"row":144,"column":39},"end":{"row":145,"column":0},"action":"insert","lines":["",""],"id":1801},{"start":{"row":145,"column":0},"end":{"row":145,"column":14},"action":"insert","lines":["              "]}],[{"start":{"row":145,"column":51},"end":{"row":146,"column":12},"action":"remove","lines":["","            "],"id":1802}],[{"start":{"row":145,"column":51},"end":{"row":147,"column":10},"action":"insert","lines":["","              ","          "],"id":1803}],[{"start":{"row":147,"column":13},"end":{"row":148,"column":8},"action":"remove","lines":["","        "],"id":1804}],[{"start":{"row":147,"column":13},"end":{"row":149,"column":8},"action":"insert","lines":["","            ","        "],"id":1805}],[{"start":{"row":149,"column":11},"end":{"row":150,"column":4},"action":"remove","lines":["","    "],"id":1806}],[{"start":{"row":149,"column":11},"end":{"row":151,"column":4},"action":"insert","lines":["","        ","    "],"id":1807}],[{"start":{"row":148,"column":8},"end":{"row":148,"column":12},"action":"remove","lines":["    "],"id":1808}],[{"start":{"row":148,"column":4},"end":{"row":148,"column":8},"action":"remove","lines":["    "],"id":1809}],[{"start":{"row":148,"column":0},"end":{"row":148,"column":4},"action":"remove","lines":["    "],"id":1810}],[{"start":{"row":147,"column":13},"end":{"row":148,"column":0},"action":"remove","lines":["",""],"id":1811}],[{"start":{"row":149,"column":4},"end":{"row":149,"column":8},"action":"remove","lines":["    "],"id":1812}],[{"start":{"row":149,"column":0},"end":{"row":149,"column":4},"action":"remove","lines":["    "],"id":1813}],[{"start":{"row":148,"column":11},"end":{"row":149,"column":0},"action":"remove","lines":["",""],"id":1814}],[{"start":{"row":150,"column":1},"end":{"row":150,"column":2},"action":"remove","lines":[" "],"id":1815}],[{"start":{"row":150,"column":0},"end":{"row":150,"column":1},"action":"remove","lines":[" "],"id":1816}],[{"start":{"row":149,"column":7},"end":{"row":150,"column":2},"action":"remove","lines":["","  "],"id":1817}],[{"start":{"row":146,"column":13},"end":{"row":146,"column":14},"action":"remove","lines":[" "],"id":1818}],[{"start":{"row":146,"column":12},"end":{"row":146,"column":13},"action":"remove","lines":[" "],"id":1819}],[{"start":{"row":146,"column":8},"end":{"row":146,"column":12},"action":"remove","lines":["    "],"id":1820}],[{"start":{"row":146,"column":4},"end":{"row":146,"column":8},"action":"remove","lines":["    "],"id":1821}],[{"start":{"row":146,"column":0},"end":{"row":146,"column":4},"action":"remove","lines":["    "],"id":1822}],[{"start":{"row":145,"column":51},"end":{"row":146,"column":0},"action":"remove","lines":["",""],"id":1823}],[{"start":{"row":140,"column":26},"end":{"row":141,"column":0},"action":"insert","lines":["",""],"id":1824},{"start":{"row":141,"column":0},"end":{"row":141,"column":10},"action":"insert","lines":["          "]}],[{"start":{"row":141,"column":10},"end":{"row":142,"column":0},"action":"insert","lines":["",""],"id":1825},{"start":{"row":142,"column":0},"end":{"row":142,"column":10},"action":"insert","lines":["          "]}],[{"start":{"row":142,"column":10},"end":{"row":144,"column":13},"action":"insert","lines":["logs.forEach(function (log) {","              socket.emit('calllog-all-logs', log);","          });"],"id":1826}],[{"start":{"row":142,"column":10},"end":{"row":142,"column":14},"action":"remove","lines":["logs"],"id":1827},{"start":{"row":142,"column":10},"end":{"row":142,"column":17},"action":"insert","lines":["results"]}],[{"start":{"row":142,"column":36},"end":{"row":142,"column":39},"action":"remove","lines":["log"],"id":1828},{"start":{"row":142,"column":36},"end":{"row":142,"column":37},"action":"insert","lines":["r"]}],[{"start":{"row":142,"column":37},"end":{"row":142,"column":38},"action":"insert","lines":["e"],"id":1829}],[{"start":{"row":142,"column":38},"end":{"row":142,"column":39},"action":"insert","lines":["s"],"id":1830}],[{"start":{"row":142,"column":39},"end":{"row":142,"column":40},"action":"insert","lines":["u"],"id":1831}],[{"start":{"row":142,"column":40},"end":{"row":142,"column":41},"action":"insert","lines":["l"],"id":1832}],[{"start":{"row":142,"column":41},"end":{"row":142,"column":42},"action":"insert","lines":["t"],"id":1833}],[{"start":{"row":143,"column":14},"end":{"row":143,"column":51},"action":"remove","lines":["socket.emit('calllog-all-logs', log);"],"id":1834}],[{"start":{"row":140,"column":21},"end":{"row":140,"column":25},"action":"remove","lines":["null"],"id":1835},{"start":{"row":140,"column":21},"end":{"row":140,"column":23},"action":"insert","lines":["[]"]}],[{"start":{"row":143,"column":14},"end":{"row":143,"column":18},"action":"insert","lines":["logs"],"id":1836}],[{"start":{"row":143,"column":18},"end":{"row":143,"column":19},"action":"insert","lines":["."],"id":1837}],[{"start":{"row":143,"column":19},"end":{"row":143,"column":20},"action":"insert","lines":["p"],"id":1838}],[{"start":{"row":143,"column":20},"end":{"row":143,"column":21},"action":"insert","lines":["u"],"id":1839}],[{"start":{"row":143,"column":21},"end":{"row":143,"column":22},"action":"insert","lines":["s"],"id":1840}],[{"start":{"row":143,"column":22},"end":{"row":143,"column":23},"action":"insert","lines":["h"],"id":1841}],[{"start":{"row":143,"column":23},"end":{"row":143,"column":25},"action":"insert","lines":["()"],"id":1842}],[{"start":{"row":143,"column":25},"end":{"row":143,"column":26},"action":"insert","lines":[";"],"id":1843}],[{"start":{"row":143,"column":24},"end":{"row":143,"column":26},"action":"insert","lines":["{}"],"id":1844}],[{"start":{"row":143,"column":25},"end":{"row":143,"column":26},"action":"insert","lines":["i"],"id":1845}],[{"start":{"row":143,"column":26},"end":{"row":143,"column":27},"action":"insert","lines":["d"],"id":1846}],[{"start":{"row":143,"column":27},"end":{"row":143,"column":28},"action":"insert","lines":[":"],"id":1847}],[{"start":{"row":142,"column":45},"end":{"row":143,"column":0},"action":"insert","lines":["",""],"id":1848},{"start":{"row":143,"column":0},"end":{"row":143,"column":14},"action":"insert","lines":["              "]}],[{"start":{"row":143,"column":14},"end":{"row":143,"column":15},"action":"insert","lines":["v"],"id":1849}],[{"start":{"row":143,"column":15},"end":{"row":143,"column":16},"action":"insert","lines":["a"],"id":1850}],[{"start":{"row":143,"column":16},"end":{"row":143,"column":17},"action":"insert","lines":["r"],"id":1851}],[{"start":{"row":143,"column":17},"end":{"row":143,"column":18},"action":"insert","lines":[" "],"id":1852}],[{"start":{"row":143,"column":18},"end":{"row":143,"column":19},"action":"insert","lines":["i"],"id":1853}],[{"start":{"row":143,"column":19},"end":{"row":143,"column":20},"action":"insert","lines":["d"],"id":1854}],[{"start":{"row":143,"column":20},"end":{"row":143,"column":21},"action":"insert","lines":[" "],"id":1855}],[{"start":{"row":143,"column":21},"end":{"row":143,"column":22},"action":"insert","lines":["="],"id":1856}],[{"start":{"row":143,"column":22},"end":{"row":143,"column":23},"action":"insert","lines":[" "],"id":1857}],[{"start":{"row":143,"column":23},"end":{"row":143,"column":24},"action":"insert","lines":["r"],"id":1858}],[{"start":{"row":143,"column":24},"end":{"row":143,"column":25},"action":"insert","lines":["e"],"id":1859}],[{"start":{"row":143,"column":25},"end":{"row":143,"column":26},"action":"insert","lines":["s"],"id":1860}],[{"start":{"row":143,"column":26},"end":{"row":143,"column":27},"action":"insert","lines":["u"],"id":1861}],[{"start":{"row":143,"column":27},"end":{"row":143,"column":28},"action":"insert","lines":["l"],"id":1862}],[{"start":{"row":143,"column":28},"end":{"row":143,"column":29},"action":"insert","lines":["t"],"id":1863}],[{"start":{"row":143,"column":29},"end":{"row":143,"column":30},"action":"insert","lines":["."],"id":1864}],[{"start":{"row":142,"column":45},"end":{"row":143,"column":30},"action":"remove","lines":["","              var id = result."],"id":1865}],[{"start":{"row":143,"column":25},"end":{"row":143,"column":27},"action":"remove","lines":["id"],"id":1866},{"start":{"row":143,"column":25},"end":{"row":143,"column":31},"action":"insert","lines":["result"]}],[{"start":{"row":143,"column":32},"end":{"row":143,"column":38},"action":"insert","lines":["result"],"id":1867}],[{"start":{"row":143,"column":25},"end":{"row":143,"column":31},"action":"remove","lines":["result"],"id":1868},{"start":{"row":143,"column":25},"end":{"row":143,"column":26},"action":"insert","lines":["f"]}],[{"start":{"row":143,"column":26},"end":{"row":143,"column":27},"action":"insert","lines":["i"],"id":1869}],[{"start":{"row":143,"column":27},"end":{"row":143,"column":28},"action":"insert","lines":["l"],"id":1870}],[{"start":{"row":143,"column":28},"end":{"row":143,"column":29},"action":"insert","lines":["e"],"id":1871}],[{"start":{"row":147,"column":9},"end":{"row":147,"column":10},"action":"remove","lines":[" "],"id":1872}],[{"start":{"row":147,"column":8},"end":{"row":147,"column":9},"action":"remove","lines":[" "],"id":1873}],[{"start":{"row":147,"column":4},"end":{"row":147,"column":8},"action":"remove","lines":["    "],"id":1874}],[{"start":{"row":147,"column":0},"end":{"row":147,"column":4},"action":"remove","lines":["    "],"id":1875}],[{"start":{"row":146,"column":10},"end":{"row":147,"column":0},"action":"remove","lines":["",""],"id":1876}],[{"start":{"row":146,"column":9},"end":{"row":146,"column":10},"action":"remove","lines":[" "],"id":1877}],[{"start":{"row":146,"column":8},"end":{"row":146,"column":9},"action":"remove","lines":[" "],"id":1878}],[{"start":{"row":146,"column":4},"end":{"row":146,"column":8},"action":"remove","lines":["    "],"id":1879}],[{"start":{"row":146,"column":0},"end":{"row":146,"column":4},"action":"remove","lines":["    "],"id":1880}],[{"start":{"row":145,"column":10},"end":{"row":146,"column":0},"action":"remove","lines":["",""],"id":1881}],[{"start":{"row":194,"column":16},"end":{"row":195,"column":0},"action":"insert","lines":["",""],"id":1882},{"start":{"row":195,"column":0},"end":{"row":195,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":195,"column":12},"end":{"row":196,"column":0},"action":"insert","lines":["",""],"id":1883},{"start":{"row":196,"column":0},"end":{"row":196,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":195,"column":12},"end":{"row":196,"column":0},"action":"insert","lines":["",""],"id":1884},{"start":{"row":196,"column":0},"end":{"row":196,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":196,"column":12},"end":{"row":201,"column":3},"action":"insert","lines":["fs.readFile('/etc/hosts', 'utf8', function (err,data) {","  if (err) {","    return console.log(err);","  }","  console.log(data);","});"],"id":1885}],[{"start":{"row":197,"column":0},"end":{"row":197,"column":4},"action":"insert","lines":["    "],"id":1886},{"start":{"row":198,"column":0},"end":{"row":198,"column":4},"action":"insert","lines":["    "]},{"start":{"row":199,"column":0},"end":{"row":199,"column":4},"action":"insert","lines":["    "]},{"start":{"row":200,"column":0},"end":{"row":200,"column":4},"action":"insert","lines":["    "]},{"start":{"row":201,"column":0},"end":{"row":201,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":197,"column":0},"end":{"row":197,"column":4},"action":"insert","lines":["    "],"id":1887},{"start":{"row":198,"column":0},"end":{"row":198,"column":4},"action":"insert","lines":["    "]},{"start":{"row":199,"column":0},"end":{"row":199,"column":4},"action":"insert","lines":["    "]},{"start":{"row":200,"column":0},"end":{"row":200,"column":4},"action":"insert","lines":["    "]},{"start":{"row":201,"column":0},"end":{"row":201,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":197,"column":0},"end":{"row":197,"column":4},"action":"insert","lines":["    "],"id":1888},{"start":{"row":198,"column":0},"end":{"row":198,"column":4},"action":"insert","lines":["    "]},{"start":{"row":199,"column":0},"end":{"row":199,"column":4},"action":"insert","lines":["    "]},{"start":{"row":200,"column":0},"end":{"row":200,"column":4},"action":"insert","lines":["    "]},{"start":{"row":201,"column":0},"end":{"row":201,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":196,"column":12},"end":{"row":196,"column":25},"action":"insert","lines":["CallLogServer"],"id":1889}],[{"start":{"row":196,"column":25},"end":{"row":196,"column":26},"action":"insert","lines":["."],"id":1890}],[{"start":{"row":196,"column":38},"end":{"row":196,"column":50},"action":"remove","lines":["'/etc/hosts'"],"id":1891},{"start":{"row":196,"column":38},"end":{"row":196,"column":39},"action":"insert","lines":["f"]}],[{"start":{"row":196,"column":39},"end":{"row":196,"column":40},"action":"insert","lines":["i"],"id":1892}],[{"start":{"row":196,"column":40},"end":{"row":196,"column":41},"action":"insert","lines":["l"],"id":1893}],[{"start":{"row":196,"column":41},"end":{"row":196,"column":42},"action":"insert","lines":["e"],"id":1894}],[{"start":{"row":203,"column":10},"end":{"row":203,"column":29},"action":"remove","lines":["results.push(file);"],"id":1895}],[{"start":{"row":200,"column":14},"end":{"row":200,"column":32},"action":"remove","lines":["console.log(data);"],"id":1896},{"start":{"row":200,"column":14},"end":{"row":200,"column":33},"action":"insert","lines":["results.push(file);"]}],[{"start":{"row":201,"column":15},"end":{"row":203,"column":10},"action":"remove","lines":["","            ","          "],"id":1897}],[{"start":{"row":195,"column":0},"end":{"row":195,"column":12},"action":"remove","lines":["            "],"id":1898}],[{"start":{"row":194,"column":16},"end":{"row":195,"column":0},"action":"remove","lines":["",""],"id":1899}]]},"ace":{"folds":[],"scrolltop":1873.7999629974365,"scrollleft":0,"selection":{"start":{"row":195,"column":17},"end":{"row":195,"column":17},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":104,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1459310414883}