{"changed":true,"filter":false,"title":"server.js","tooltip":"/server.js","value":"//\n// # SimpleServer\n//\n// A simple chat server using Socket.IO, Express, and Async.\n//\nvar http = require('http');\nvar path = require('path');\n\nvar async = require('async');\nvar socketio = require('socket.io');\nvar express = require('express');\n\n\nvar strikeTemp = require('./beer/strikeTemp.js');\n\nvar sha256 = require('./client/js/hashing/sha256/sha256.js');\n\nvar chatSocketIOc9 = require('./client/app/chat.js');\n//var chatSocketIODoubleHash = require('./client/app/chat.js');\n\nvar ioCon = chatSocketIOc9;\n\nvar bcrypt = require('bcrypt');\n\nvar passTheHashAuth = require('./auth/h3Auth.js');\nvar monty = require('./monty/monty.js');\n\nvar mysteryUserSalts = {};\nvar userMysteryUserSalts = false;\n\nvar authMaxTimeDifferenceInMiliSeconds = 1000;\n\nvar systemSalt = \"RANDOMIZE_THIS_VALUE_ON_PRODUCTION_SERVERS\";\n\n//var getIp = require('ipware')().get_ip;\nvar getIp = function getIp(req){\n    var ip = req.headers['x-forwarded-for'] || \n     req.connection.remoteAddress || \n     req.socket.remoteAddress ||\n     req.connection.socket.remoteAddress;\n     \n     var clientIp = {clientIp:ip};\n     \n     return clientIp;\n}\n\n\n\n\n//\n// ## SimpleServer `SimpleServer(obj)`\n//\n// Creates a new instance of SimpleServer with the following options:\n//  * `port` - The HTTP port to listen on. If `process.env.PORT` is set, _it overrides this value_.\n//\nvar router = express();\nrouter.use(express.bodyParser());\nvar server = http.createServer(router);\nvar io = socketio.listen(server);\n\n\n//\nvar fs        = require('fs');\nvar publicdir = __dirname + '/client';\n\n//THis allows for navigation to html pages without the .html extension\nrouter.use(function(req, res, next) {\n  if (req.path.indexOf('.') === -1) {\n    var file = publicdir + req.path + '.html';\n    fs.exists(file, function(exists) {\n      if (exists)\n        req.url += '.html';\n      next();\n    });\n  }\n  else\n    next();\n});\nrouter.use(express.static(publicdir));\n//router.use(express.static(path.resolve(__dirname, 'client')));\n\n\nvar messages = [];\nvar sockets = [];\n\n\n\nvar database = {};\nvar crawlerDatabase = {};\n\n\n\n\nvar guid = require('./utils/guid.js');\n\nrouter.get('/api/guid', function(req, res) {\n\tres.json(200, {guid:guid.generate(req.query.useDashes)});\n});\n\n\n\n\n\n\n\nrouter.get('/api/beer/striketemp', function(req, res) {\n\tres.json(200, strikeTemp.calc(req.query.quarts, req.query.lbs, req.query.t1, req.query.t2));\n});\n\nrouter.get('/api/beer', function(req, res) {\n\tres.json(200, { Message: 'Drink Beer' });\n});\n\nrouter.get('/api/data', function(req, res) {\n    var key = req.query.key;\n    var id = req.query.id;\n    \n    \n    if(database[key] === undefined){\n        res.json(404, { Message: \"No datasource named [\" + key + \"] was found.  Start it now!\"});\t\n    }\n    else{\n        if(id === undefined){\n            res.json(200, database[key]);\n        }\n        else{\n            var item = database[key][id];\n            \n            if(item !== undefined){\n                res.json(200, item);\n            }\n            else{\n                res.json(404, { Message: \"No item with id [\"+id+\"] found in datasource with key [\" + key + \"].\"});\n            }\n        }\n    }\n});\n\n\n\nrouter.post('/api/data', function(req, res) {\n    var key = req.query.key;\n    if(database[key] === undefined){\n        database[key] = {};\n    }\n    var newGuid = guid.generate(true);\n    \n    database[key][newGuid] = JSON.parse(req.body.bodyvalue);\n    \n    res.json(200, { id: newGuid });\n\t\n});\n\n\nrouter.delete('/api/data', function(req, res) {\n    var key = req.query.key;\n    var id = req.query.id;\n    \n    if(key === undefined){\n        res.json(404, { Message: \"No key parameter was specified.\"});\n    }\n    else if(id === undefined){\n        res.json(404, { Message: \"No id parameter was specified.\"});\n    }\n    else{\n    \n        if(database[key] === undefined){\n            res.json(404, { Message: \"No datasource named [\" + key + \"] was found.  Start it now.\"});\t\n        }\n        else{\n            \n            if(database[key][id] !== undefined){\n                delete database[key][id];\n                res.json(200, { deleted: true });\n            }\n            else{\n                res.json(404, { Message: \"No item with id [\"+id+\"] found in datasource with key [\" + key + \"].\"});\n            }\n        }\n    }\n});\n\n\nioCon.init(sockets, messages, async);\nio.on('connection', ioCon.onConnection);\n\n\nserver.listen(process.env.PORT || 3000, process.env.IP || \"0.0.0.0\", function(){\n  var addr = server.address();\n  console.log(\"Chat server listening at\", addr.address + \":\" + addr.port);\n});\n\n\n\n\n\n\n\n\n\nrouter.get('/api/getUserSalts', function(req, res) {\n    res.json(200, passTheHashAuth.getUserSalts(sha256, getIp(req).clientIp, req.query.userName, false, systemSalt));\n});\n\n\nrouter.get('/api/auth', function(req, res) {\n    \n    \n    var auth = null;\n    \n    var youGotYourShitTogether = false;\n    \n    if(youGotYourShitTogether){\n        //TODO Implement auth that expects a plain text password here\n        auth = {};\n    }\n    else{\n        var somethingThatShouldntPassForAuth = passTheHashAuth.ingest(sha256, getIp(req).clientIp, req.query.userName, req.query.h3, req.query.date, authMaxTimeDifferenceInMiliSeconds);\n        auth = somethingThatShouldntPassForAuth;\n    }\n    \n\tres.json(200, auth);\n});\n\n\n\n\nrouter.get('/api/montyStats', function(req, res) {\n    res.json(200, monty.getMontyStats(req.query.players, req.query.games));\n});\n\n\nrouter.get('/api/playMontyGame', function(req, res) {\n\tres.json(200, monty.playMontyGame(req.query.doorNumber,req.query.doSwitch));\n});","undoManager":{"mark":13,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":61,"column":1},"end":{"row":62,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":0},"end":{"row":62,"column":1},"action":"remove","lines":["'"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":1},"end":{"row":62,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":61,"column":1},"action":"remove","lines":["'"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":62,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":0},"end":{"row":63,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":63,"column":0},"end":{"row":64,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":64,"column":0},"end":{"row":65,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":63,"column":0},"end":{"row":78,"column":35},"action":"insert","lines":["var fs        = require('fs');","var publicdir = __dirname + '/public';","","app.use(function(req, res, next) {","  if (req.path.indexOf('.') === -1) {","    var file = publicdir + req.path + '.html';","    fs.exists(file, function(exists) {","      if (exists)","        req.url += '.html';","      next();","    });","  }","  else","    next();","});","app.use(express.static(publicdir));"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":0},"end":{"row":66,"column":3},"action":"remove","lines":["app"]},{"start":{"row":66,"column":0},"end":{"row":66,"column":6},"action":"insert","lines":["router"]}]}],[{"group":"doc","deltas":[{"start":{"row":78,"column":0},"end":{"row":78,"column":3},"action":"remove","lines":["app"]},{"start":{"row":78,"column":0},"end":{"row":78,"column":6},"action":"insert","lines":["router"]}]}],[{"group":"doc","deltas":[{"start":{"row":64,"column":30},"end":{"row":64,"column":36},"action":"remove","lines":["public"]},{"start":{"row":64,"column":30},"end":{"row":64,"column":36},"action":"insert","lines":["client"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":0},"end":{"row":60,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":1},"end":{"row":60,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":0},"end":{"row":60,"column":64},"action":"remove","lines":["//router.use(express.static(path.resolve(__dirname, 'client')));"]}]}],[{"group":"doc","deltas":[{"start":{"row":78,"column":38},"end":{"row":79,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":79,"column":0},"end":{"row":79,"column":64},"action":"insert","lines":["//router.use(express.static(path.resolve(__dirname, 'client')));"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":62,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":61,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":1},"end":{"row":61,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":2},"end":{"row":61,"column":3},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":3},"end":{"row":61,"column":4},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":4},"end":{"row":61,"column":5},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":5},"end":{"row":61,"column":6},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":6},"end":{"row":61,"column":7},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":6},"end":{"row":61,"column":7},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":5},"end":{"row":61,"column":6},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":4},"end":{"row":61,"column":5},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":3},"end":{"row":61,"column":4},"action":"remove","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":2},"end":{"row":61,"column":3},"action":"remove","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":64,"column":0},"end":{"row":65,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":0},"end":{"row":65,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":1},"end":{"row":65,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":2},"end":{"row":65,"column":3},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":3},"end":{"row":65,"column":4},"action":"insert","lines":["H"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":4},"end":{"row":65,"column":5},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":5},"end":{"row":65,"column":6},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":6},"end":{"row":65,"column":7},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":7},"end":{"row":65,"column":8},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":8},"end":{"row":65,"column":9},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":9},"end":{"row":65,"column":10},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":10},"end":{"row":65,"column":11},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":11},"end":{"row":65,"column":12},"action":"insert","lines":["w"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":12},"end":{"row":65,"column":13},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":13},"end":{"row":65,"column":14},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":14},"end":{"row":65,"column":15},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":15},"end":{"row":65,"column":16},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":16},"end":{"row":65,"column":17},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":17},"end":{"row":65,"column":18},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":18},"end":{"row":65,"column":19},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":19},"end":{"row":65,"column":20},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":20},"end":{"row":65,"column":21},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":21},"end":{"row":65,"column":22},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":22},"end":{"row":65,"column":23},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":23},"end":{"row":65,"column":24},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":24},"end":{"row":65,"column":25},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":25},"end":{"row":65,"column":26},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":26},"end":{"row":65,"column":27},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":27},"end":{"row":65,"column":28},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":28},"end":{"row":65,"column":29},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":29},"end":{"row":65,"column":30},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":30},"end":{"row":65,"column":31},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":31},"end":{"row":65,"column":32},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":32},"end":{"row":65,"column":33},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":33},"end":{"row":65,"column":34},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":34},"end":{"row":65,"column":35},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":35},"end":{"row":65,"column":36},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":36},"end":{"row":65,"column":37},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":37},"end":{"row":65,"column":38},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":38},"end":{"row":65,"column":39},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":39},"end":{"row":65,"column":40},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":40},"end":{"row":65,"column":41},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":41},"end":{"row":65,"column":42},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":42},"end":{"row":65,"column":43},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":43},"end":{"row":65,"column":44},"action":"insert","lines":["w"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":44},"end":{"row":65,"column":45},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":45},"end":{"row":65,"column":46},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":46},"end":{"row":65,"column":47},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":47},"end":{"row":65,"column":48},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":48},"end":{"row":65,"column":49},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":49},"end":{"row":65,"column":50},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":50},"end":{"row":65,"column":51},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":51},"end":{"row":65,"column":52},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":52},"end":{"row":65,"column":53},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":53},"end":{"row":65,"column":54},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":54},"end":{"row":65,"column":55},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":55},"end":{"row":65,"column":56},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":56},"end":{"row":65,"column":57},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":57},"end":{"row":65,"column":58},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":58},"end":{"row":65,"column":59},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":59},"end":{"row":65,"column":60},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":60},"end":{"row":65,"column":61},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":61},"end":{"row":65,"column":62},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":62},"end":{"row":65,"column":63},"action":"insert","lines":["x"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":63},"end":{"row":65,"column":64},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":64},"end":{"row":65,"column":65},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":65},"end":{"row":65,"column":66},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":66},"end":{"row":65,"column":67},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":67},"end":{"row":65,"column":68},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":68},"end":{"row":65,"column":69},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":69},"end":{"row":65,"column":70},"action":"insert","lines":["n"]}]}]]},"ace":{"folds":[],"scrolltop":838.9090566635132,"scrollleft":0,"selection":{"start":{"row":77,"column":3},"end":{"row":77,"column":3},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1419432238096}