{"changed":true,"filter":false,"title":"server.js","tooltip":"/server.js","value":"//\n// # SimpleServer\n//\n// A simple chat server using Socket.IO, Express, and Async.\n//\nvar publicdir = __dirname + '/client';\n\nvar fs        = require('fs');\nvar http = require('http');\n//var https = require('https');\nvar path = require('path');\n\nvar async = require('async');\nvar socketio = require('socket.io');\nvar express = require('express');\n//var bcrypt = require('bcrypt');\n//var keyDel = require('key-del');\n\nvar guid = require('./utils/guid.js');\nvar strikeTemp = require('./beer/strikeTemp.js');\nvar sha256 = require('./client/js/hashing/sha256/sha256.js');\n\n//var chatSocketIOc9 = require('./client/app/chat.js');\nvar bcryptPlusClientShaChat = require('./client/app/bcryptPlusClientShaChat.js');\n\nvar socketIO_OnConnectionProvider = bcryptPlusClientShaChat;\n\nvar database = {};\n\nvar socketIOConnectionData = {};\nsocketIOConnectionData.async = async;\nsocketIOConnectionData.guidFactory = guid;\n//socketIOConnectionData.keyDel = keyDel;\n\nsocketIO_OnConnectionProvider.init(socketIOConnectionData);\n\nvar monty = require('./monty/monty.js');\n\n\n//var getIp = require('ipware')().get_ip;\nvar getIp = function getIp(req){\n    var ip = req.headers['x-forwarded-for'] || \n     req.connection.remoteAddress || \n     req.socket.remoteAddress ||\n     req.connection.socket.remoteAddress;\n     \n     var clientIp = {clientIp:ip};\n     \n     return clientIp;\n}\n\n\n\n\n//\n// ## SimpleServer `SimpleServer(obj)`\n//\n// Creates a new instance of SimpleServer with the following options:\n//  * `port` - The HTTP port to listen on. If `process.env.PORT` is set, _it overrides this value_.\n//\nvar router = express();\nrouter.use(express.bodyParser());\nvar server = http.createServer(router);\n/*\nvar secureServer = https.createServer(router);\n\nvar ssl = {\n    key: fs.readFileSync('./ssl/private.key', 'utf8'),\n    cert: fs.readFileSync('./ssl/domain.org.crt', 'utf8'),\n    ca: [fs.readFileSync('./ssl/bundle_01.crt', 'utf8'),\n         fs.readFileSync('./ssl/bundle_02.crt', 'utf8')]\n};\n\n*/\nvar io = socketio.listen(server);\n//var secureIo = socketio.listen(secureServer);\n\n//\n\n\n//This allows for navigation to html pages without the .html extension\nrouter.use(function(req, res, next) {\n  if (req.path.indexOf('.') === -1) {\n    var file = publicdir + req.path + '.html';\n    fs.exists(file, function(exists) {\n      if (exists)\n        req.url += '.html';\n      next();\n    });\n  }\n  else\n    next();\n});\nrouter.use(express.static(publicdir));\n//router.use(express.static(path.resolve(__dirname, 'client')));\n\n\n\n\n\n\n\n\n\n\nrouter.get('/api/guid', function(req, res) {\n\tres.json(200, {guid:guid.generate(req.query.useDashes)});\n});\n\n\n\n\n\n\n\nrouter.get('/api/beer/striketemp', function(req, res) {\n\tres.json(200, strikeTemp.calc(req.query.quarts, req.query.lbs, req.query.t1, req.query.t2));\n});\n\nrouter.get('/api/beer', function(req, res) {\n\tres.json(200, { Message: 'Drink Beer' });\n});\n\nrouter.get('/api/data', function(req, res) {\n    var key = req.query.key;\n    var id = req.query.id;\n    \n    \n    if(database[key] === undefined){\n        res.json(404, { Message: \"No datasource named [\" + key + \"] was found.  Start it now!\"});\t\n    }\n    else{\n        if(id === undefined){\n            res.json(200, database[key]);\n        }\n        else{\n            var item = database[key][id];\n            \n            if(item !== undefined){\n                res.json(200, item);\n            }\n            else{\n                res.json(404, { Message: \"No item with id [\"+id+\"] found in datasource with key [\" + key + \"].\"});\n            }\n        }\n    }\n});\n\n\n\nrouter.post('/api/data', function(req, res) {\n    var key = req.query.key;\n    if(database[key] === undefined){\n        database[key] = {};\n    }\n    var newGuid = guid.generate(true);\n    \n    database[key][newGuid] = JSON.parse(req.body.bodyvalue);\n    \n    res.json(200, { id: newGuid });\n\t\n});\n\n\nrouter.delete('/api/data', function(req, res) {\n    var key = req.query.key;\n    var id = req.query.id;\n    \n    if(key === undefined){\n        res.json(404, { Message: \"No key parameter was specified.\"});\n    }\n    else if(id === undefined){\n        res.json(404, { Message: \"No id parameter was specified.\"});\n    }\n    else{\n    \n        if(database[key] === undefined){\n            res.json(404, { Message: \"No datasource named [\" + key + \"] was found.  Start it now.\"});\t\n        }\n        else{\n            \n            if(database[key][id] !== undefined){\n                delete database[key][id];\n                res.json(200, { deleted: true });\n            }\n            else{\n                res.json(404, { Message: \"No item with id [\"+id+\"] found in datasource with key [\" + key + \"].\"});\n            }\n        }\n    }\n});\n\n\nio.on('connection', socketIO_OnConnectionProvider.onConnection);\n\n\nserver.listen(process.env.PORT || 3000, process.env.IP || \"0.0.0.0\", function(){\n  var addr = server.address();\n  console.log(\"Chat server listening at\", addr.address + \":\" + addr.port);\n});\n\n\n/*\nhttps.createServer(ssl, function(req, res) {\n    var addr = secureServer.address();\n    console.log(\"SSL available at\", addr.address + \":\" + addr.port);\n}).listen(443);\n*/\n\n\n\n\n\n\n\n\nrouter.get('/api/getUserSalts', function(req, res) {\n    var inputData = {};\n    inputData.userName = req.query.userName;\n    inputData.isClientCall = true;\n    res.json(200, socketIO_OnConnectionProvider.getUserSalts(inputData));\n});\n\n\n/*\nrouter.get('/api/auth', function(req, res) {\n    var auth = socketIO_OnConnectionProvider.authorize(req.query.userName, req.query.h3, req.query.date, authMaxTimeDifferenceInMiliSeconds);\n\tres.json(200, auth);\n});\n*/\n\nrouter.post('/api/auth', function(req, res) {\n\n    var newGuid = guid.generate(true);\n    \n    var authData = JSON.parse(req.body.bodyvalue);\n    \n    var auth = socketIO_OnConnectionProvider.authorize(authData.userName, authData.h3);\n\tres.json(200, auth);\n    \n    res.json(200, auth);\n\t\n});\n\n\n\nrouter.get('/api/montyStats', function(req, res) {\n    res.json(200, monty.getMontyStats(req.query.players, req.query.games));\n});\n\n\nrouter.get('/api/playMontyGame', function(req, res) {\n\tres.json(200, monty.playMontyGame(req.query.doorNumber,req.query.doSwitch));\n});","undoManager":{"mark":98,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":192,"column":17},"end":{"row":192,"column":18},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":16},"end":{"row":192,"column":17},"action":"insert","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":17},"end":{"row":192,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":18},"end":{"row":192,"column":19},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":19},"end":{"row":192,"column":20},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":20},"end":{"row":192,"column":21},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":21},"end":{"row":192,"column":22},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":22},"end":{"row":192,"column":23},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":23},"end":{"row":192,"column":24},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":24},"end":{"row":192,"column":25},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":25},"end":{"row":192,"column":26},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":192,"column":26},"end":{"row":192,"column":27},"action":"insert","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":31},"end":{"row":62,"column":37},"action":"remove","lines":["server"]},{"start":{"row":62,"column":31},"end":{"row":62,"column":43},"action":"insert","lines":["secureServer"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":0},"end":{"row":62,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":1},"end":{"row":62,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":47},"end":{"row":62,"column":48},"action":"insert","lines":["?"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":48},"end":{"row":62,"column":49},"action":"insert","lines":["?"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":0},"end":{"row":60,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":1},"end":{"row":60,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":6,"column":0},"end":{"row":6,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":6,"column":1},"end":{"row":6,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":189,"column":0},"end":{"row":190,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":0},"end":{"row":190,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":190,"column":1},"end":{"row":190,"column":2},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":195,"column":0},"end":{"row":195,"column":1},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":195,"column":1},"end":{"row":195,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":3},"end":{"row":68,"column":4},"action":"remove","lines":["H"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":3},"end":{"row":68,"column":4},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":47},"end":{"row":62,"column":49},"action":"remove","lines":["??"]}]}],[{"group":"doc","deltas":[{"start":{"row":59,"column":39},"end":{"row":60,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":0},"end":{"row":60,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":60,"column":1},"end":{"row":60,"column":2},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":48},"end":{"row":62,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":0},"end":{"row":62,"column":1},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":62,"column":1},"end":{"row":62,"column":2},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":48},"end":{"row":62,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":1},"end":{"row":61,"column":2},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":61,"column":1},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":0},"end":{"row":69,"column":38},"action":"remove","lines":["var fs        = require('fs');","var publicdir = __dirname + '/client';"]}]}],[{"group":"doc","deltas":[{"start":{"row":4,"column":2},"end":{"row":5,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":5,"column":0},"end":{"row":6,"column":38},"action":"insert","lines":["var fs        = require('fs');","var publicdir = __dirname + '/client';"]}]}],[{"group":"doc","deltas":[{"start":{"row":6,"column":0},"end":{"row":6,"column":38},"action":"remove","lines":["var publicdir = __dirname + '/client';"]}]}],[{"group":"doc","deltas":[{"start":{"row":4,"column":2},"end":{"row":5,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":5,"column":0},"end":{"row":5,"column":38},"action":"insert","lines":["var publicdir = __dirname + '/client';"]}]}],[{"group":"doc","deltas":[{"start":{"row":5,"column":38},"end":{"row":6,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":8,"column":0},"end":{"row":9,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":8,"column":0},"end":{"row":9,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":7,"column":30},"end":{"row":8,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":1},"end":{"row":9,"column":2},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":0},"end":{"row":9,"column":1},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":64,"column":46},"end":{"row":65,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":0},"end":{"row":66,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":0},"end":{"row":78,"column":15},"action":"insert","lines":["var fs = require('fs'),","    https = require('https');","","var ssl = {","    key: fs.readFileSync('./ssl/server.key', 'utf8'),","    cert: fs.readFileSync('./ssl/server.crt', 'utf8'),","    ca: [fs.readFileSync('./ssl/bundle_01.crt', 'utf8'),","         fs.readFileSync('./ssl/bundle_02.crt', 'utf8')]","};","","https.createServer(ssl, function(req, res) {","    //... your code here ...","}).listen(443);"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":0},"end":{"row":67,"column":29},"action":"remove","lines":["","var fs = require('fs'),","    https = require('https');"]}]}],[{"group":"doc","deltas":[{"start":{"row":65,"column":0},"end":{"row":66,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":32},"end":{"row":67,"column":38},"action":"remove","lines":["server"]},{"start":{"row":67,"column":32},"end":{"row":67,"column":33},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":33},"end":{"row":67,"column":34},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":34},"end":{"row":67,"column":35},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":35},"end":{"row":67,"column":36},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":36},"end":{"row":67,"column":37},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":37},"end":{"row":67,"column":38},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":38},"end":{"row":67,"column":39},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":33},"end":{"row":68,"column":39},"action":"remove","lines":["server"]},{"start":{"row":68,"column":33},"end":{"row":68,"column":34},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":34},"end":{"row":68,"column":35},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":35},"end":{"row":68,"column":36},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":36},"end":{"row":68,"column":37},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":37},"end":{"row":68,"column":38},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":38},"end":{"row":68,"column":39},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":39},"end":{"row":68,"column":40},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":40},"end":{"row":68,"column":41},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":41},"end":{"row":68,"column":42},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":42},"end":{"row":68,"column":43},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":0},"end":{"row":75,"column":15},"action":"remove","lines":["https.createServer(ssl, function(req, res) {","    //... your code here ...","}).listen(443);"]}]}],[{"group":"doc","deltas":[{"start":{"row":71,"column":2},"end":{"row":73,"column":0},"action":"remove","lines":["","",""]}]}],[{"group":"doc","deltas":[{"start":{"row":206,"column":3},"end":{"row":207,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":207,"column":0},"end":{"row":208,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":208,"column":0},"end":{"row":210,"column":15},"action":"insert","lines":["https.createServer(ssl, function(req, res) {","    //... your code here ...","}).listen(443);"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":4},"end":{"row":209,"column":28},"action":"remove","lines":["//... your code here ..."]},{"start":{"row":209,"column":4},"end":{"row":210,"column":95},"action":"insert","lines":["var addr = secureServer.address();","  console.log(\"(Not really!) Secure Chat server listening at\", addr.address + \":\" + addr.port);"]}]}],[{"group":"doc","deltas":[{"start":{"row":210,"column":2},"end":{"row":210,"column":4},"action":"insert","lines":["  "]}]}],[{"group":"doc","deltas":[{"start":{"row":203,"column":0},"end":{"row":207,"column":0},"action":"remove","lines":["secureServer.listen(443, process.env.IP || \"0.0.0.0\", function(){","  var addr = secureServer.address();","  console.log(\"(Not really!) Secure Chat server listening at\", addr.address + \":\" + addr.port);","});",""]}]}],[{"group":"doc","deltas":[{"start":{"row":202,"column":2},"end":{"row":203,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":17},"end":{"row":205,"column":30},"action":"remove","lines":["(Not really!)"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":46},"end":{"row":205,"column":59},"action":"insert","lines":["(Not really!)"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":47},"end":{"row":205,"column":48},"action":"remove","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":47},"end":{"row":205,"column":48},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":57},"end":{"row":205,"column":58},"action":"remove","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":17},"end":{"row":205,"column":58},"action":"remove","lines":[" Secure Chat server listening(not really)"]},{"start":{"row":205,"column":17},"end":{"row":205,"column":18},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":18},"end":{"row":205,"column":19},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":19},"end":{"row":205,"column":20},"action":"insert","lines":["L"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":20},"end":{"row":205,"column":21},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":21},"end":{"row":205,"column":22},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":22},"end":{"row":205,"column":23},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":23},"end":{"row":205,"column":24},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":24},"end":{"row":205,"column":25},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":25},"end":{"row":205,"column":26},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":26},"end":{"row":205,"column":27},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":27},"end":{"row":205,"column":28},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":28},"end":{"row":205,"column":29},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":205,"column":29},"end":{"row":205,"column":30},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":0},"end":{"row":9,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":9,"column":1},"end":{"row":9,"column":2},"action":"insert","lines":["/"]}]}]]},"ace":{"folds":[],"scrolltop":840,"scrollleft":0,"selection":{"start":{"row":70,"column":31},"end":{"row":70,"column":31},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":53,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1419659346947}